<!DOCTYPE html>
<html>
  <head>
    <link rel="stylesheet" href="main.css" />
    <title>Update Building Occupancy</title>
  </head>

  <body>
    <form id="updateForm">
      <label for="time">Time</label><br />
      <input type="datetime-local" id="currentTime" name="currentTime" />
      <br />
      <label for="building_id">Building Name:</label><br />
      <select
        id="building_id"
        name="building_id"
        onchange="updateOccupancy()"
      ></select
      ><br />
      <label for="Current_Occupancy">Current Occupancy:</label><br />
      <input
        type="number"
        id="Current_Occupancy"
        name="Current_Occupancy"
      /><br />
      <input type="submit" id="submit-button" value="Submit" />
    </form>

    <script>
      // Get the user object from sessionStorage
      var user = sessionStorage.getItem("user");

      user = JSON.parse(user);
      if (user == null) {
        alert("Please log in to view this page");
        window.location.href = "index.html";
      }
      var isStaff = user.is_staff;
      if (isStaff == false) {
        alert("you have to be staff to access this page");
        window.location.href = "index.html";
      }

      // Fetch all buildings and populate the dropdown
      window.onload = function () {
        document.getElementById("currentTime").value = new Date()
          .toISOString()
          .slice(0, 16);
        fetch("http://localhost:3000/api/buildings")
          .then((response) => response.json())
          .then((data) => {
            const select = document.getElementById("building_id");
            data.forEach((building) => {
              const option = document.createElement("option");
              console.log(building);
              option.value = building._id;
              option.text = building.Building_Name;
              select.add(option);
            });
            updateOccupancy();
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      };

      // Update the Current_Occupancy input field when a building is selected
      function updateOccupancy() {
        const building_id = document.getElementById("building_id").value;
        fetch(`http://localhost:3000/api/buildings/${building_id}`)
          .then((response) => response.json())
          .then((data) => {
            document.getElementById("Current_Occupancy").value =
              data.Current_Occupancy;
            document.getElementById("Current_Occupancy").min = 0;
            document.getElementById("Current_Occupancy").max =
              data.Max_Occupancy;
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }
      // Send a PUT request when the form is submitted
      document
        .getElementById("updateForm")
        .addEventListener("submit", function (event) {
          event.preventDefault();

          const building_id = document.getElementById("building_id").value;
          console.log(building_id);
          const building = document.getElementById("building_id").textContent;
          const occupancy = document.getElementById("Current_Occupancy").value;
          const time = document.getElementById("currentTime").value;

          fetch("http://localhost:3000/api/occupancy", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              building,
              building_id,
              occupancy,
              time,
            }),
          })
            .then((response) => response.json())
            .then((data) => {
              console.log("Success:", data);
            })
            .catch((error) => {
              console.error("Error:", error);
            });
        });
      // Function to send the POST request
      function sendPostRequest() {
        const building_id = document.getElementById("building_id").value;
        console.log(building_id);
        const building = document.getElementById("building_id").textContent;
        console.log(building);

        const occupancy = document.getElementById("Current_Occupancy").value;
        console.log(occupancy);
        const time = document.getElementById("currentTime").value;
        console.log(time);

        // Check if any of the required fields are empty
        if (!building_id || !building || !occupancy || !time) {
          console.error("Error: All fields are required.");
          return;
        }

        fetch("http://localhost:3000/api/occupancy", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            building,
            building_id,
            occupancy,
            time,
          }),
        })
          .then((response) => response.json())
          .then((data) => {
            console.log("Success:", data);
          })
          .catch((error) => {
            console.error("Error:", error);
          });
      }

      setTimeout(sendPostRequest, 15 * 1000);
      // Set interval to call sendPostRequest every 15 minutes (15 * 60 * 1000 milliseconds)
      setInterval(function () {
        location.reload();
      }, 15 * 60 * 1000);
    </script>
  </body>
</html>
